# This file was automatically generated by sbt-github-actions using the
# githubWorkflowGenerate task. You should add and commit this file to
# your git repository. It goes without saying that you shouldn't edit
# this file by hand! Instead, if you wish to make changes, you should
# change your sbt build configuration to revise the workflow description
# to meet your needs, then regenerate this file.

name: Continuous Integration

on:
  pull_request:
    branches: ['**']
  push:
    branches: ['**']

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: Build and Test
    strategy:
      matrix:
        os: [ubuntu-latest]
        scala: [2.13.11]
        java: [temurin@20]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout current branch (full)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Java (temurin@20)
        if: matrix.java == 'temurin@20'
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 20
          cache: sbt

      - name: Check that workflows are up to date
        run: sbt '++ ${{ matrix.scala }}' githubWorkflowCheck

      - name: Setup Mysql
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: 8.0
          mysql user: tailcall_main_user
          mysql database: tailcall_main_db
          mysql password: tailcall

      - name: Build project
        run: sbt '++ ${{ matrix.scala }}' test

      - name: Lint
        if: matrix.scala == '2.13.11'
        run: sbt '++ ${{ matrix.scala }}' lintCheck

      - name: Compress target directories
        run: tar cf targets.tar registry/target server/target target test-utils/target cli/target runtime/target project/target

      - name: Upload target directories
        uses: actions/upload-artifact@v3
        with:
          name: target-${{ matrix.os }}-${{ matrix.scala }}-${{ matrix.java }}
          path: targets.tar

  deploy:
    name: Deploy
    needs: [build]
    strategy:
      matrix:
        os: [ubuntu-latest]
        scala: [2.13.11]
        java: [temurin@20]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout current branch (fast)
        uses: actions/checkout@v3

      - run: sbt Docker/stage

      - run: cp ./fly.toml target/docker/stage/

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --remote-only ./target/docker/stage

  release:
    name: Release
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        os: [ubuntu-latest]
        scala: [2.13.11]
        java: [temurin@20]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    steps:
      - name: Create Release
        id: create_release
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release-drafter.yml

      - name: Create Jars
        run: sbt Universal/stage

      - name: Create ZIPs
        uses: TheDoctor0/zip-release@0.7.1
        with:
          type: zip
          filename: tailcall-${{steps.create_release.outputs.tag_name}}.zip
          directory: target/universal/stage
          exclusions: '*.git*, .metals'

      - name: Upload ZIPs
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          append_body: true
          tag_name: ${{steps.create_release.outputs.tag_name}}
          files: '*.zip'
