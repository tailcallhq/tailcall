# `execution_spec`

A Markdown-based snapshot testing framework for Tailcall.

- [Structure](#structure)
- [Test syntax](#test-syntax)
  - [Header](#header)
  - [Annotation](#annotation)
  - [Blocks](#blocks)
    - [`server`](#server)
    - [`mock`](#mock)
    - [`env`](#env)
    - [`assert`](#assert)
    - [`file`](#file)
  - [Instruction](#instruction)
- [Test process](#test-process)
- [Snapshots](#snapshots)
- [Porting from `http_spec`/`graphql_spec`](#porting-from-graphql_spechttp_spec)
- [Maintainance](#Maintenance)

## Structure

All `execution_spec` tests are located in `tests/execution/`. The results generated by these tests are stored as snapshots in `tests/snapshots/`.

## Test syntax

An `execution_spec` test is always a Markdown file with a `.md` extension. These files contain the following parts:

### Header

A level 1 heading (`#`) specifying the name of the test, and an optional paragraph after it specifying a description. There must be exactly on header in a test.

Examples:

- ```md
  # Simple test
  ```
- ```md
  # Complex test

  This is a description.
  ```

### Annotation

A level 5 heading (`#####`), with the text being one of the following:

- `##### only` -- If at least one test has the `only` annotation, the runner will only run this/these test(s).
- `##### skip` -- If a test has the `skip` annotation, the runner will not run that test.

These are usually only added to tests temporarily, so try not to commit tests with annotations. There must be either zero or one annotations in a test.

### Blocks

Blocks are level 4 headings (`####`) followed by the block type, and a code block after them. Blocks supply the runner with data, and the runner determines what to do based on the available blocks.

#### `#### server:`

A `server` block specifies a server SDL config. These are expected to be successfully parseable to have a passing test, unless the [`sdl error` instruction](#instruction) is specified, which requires the config parsing to throw an error. There must be at least one `server` block in a test.

Every test should have at least one `server` block. Some blocks (for example, `assert`) require that there be exactly one `server` block. Additionally, having exactly one `server` block in a test means that the `client` check will also be performed.

The `merge` check is always performed using every defined server block.

When the [`check identity` instruction](#instruction) is specified, the runner will attempt to perform an `identity` check, but since is a "dumb", plain-text check, it requires the `server` block's code to be written in a specific way.

Example:

````md
#### server:

```graphql
schema {
  query: Query
}

type User {
  id: Int
  name: String
}

type Query {
  user: User @http(path: "/users/1", baseURL: "http://jsonplaceholder.typicode.com")
}
```
````

#### `#### mock:`

A `mock` block specifies mocked HTTP endpoints in `YAML`. This is very similar to the `mock` field in the [`http_spec`](#http_spec) syntax.

An item of `mock` contains a `request` and a `response`.

There may be at most one `mock` block in a test.

Example:

````md
#### mock:

```graphql
- request:
    method: GET
    url: http://jsonplaceholder.typicode.com/users/1
  response:
    status: 200
    body:
      id: 1
      name: foo
```
````

#### `#### env:`

An `env` block specifies environment variables in `YAML` that the runner should use in the app context.
This is very similar to the `env` field in the [`http_spec`](#http_spec) syntax.

There may be at most one `env` block in a test.

Example:

````md
#### env:

```graphql
TEST_ID: 1
```
````

#### `#### assert:`

An `assert` block specifies HTTP requests that the runner should perform in `YAML`. This is very similar to the `assert` field in the [`http_spec`](#http_spec) syntax,
but it only contains requests. The response for each request is stored in an `assert_{i}` snapshot.

There may be at most one `assert` block in a test.

Example:

````md
#### assert:

```graphql
- method: POST
  url: http://localhost:8080/graphql
  body:
    query: query { user { name } }
```
````

#### `#### file:<filename>`

A `file` block creates a file in the spec's virtual file system. The [`server` block](#server) will only be able to access files created in this way: the true filesystem is not available to it.

Every `file` block has the filename declared in the header. The language of the code block is optional and does not matter.

Example:

````md
#### file:enum.graphql

```graphql
schema @server @upstream(baseURL: "http://jsonplaceholder.typicode.com") {
  query: Query
}

enum Foo {
  BAR
  BAZ
}

type Query {
  foo: Foo @http(path: "/foo")
}
```
````

### Instruction

A level 6 heading (`######`), with the text being one of the following:

- `###### sdl error` -- This instructs the runner to expect a failure when parsing the `server` block and to compare the result with an `errors` snapshot. This is used when testing for error handling.

There must be exactly zero or one instruction in a test.

## Test process

1. The runner reads all tests, and selects the ones to run based on the following:
   - If a path to a test was given in the first command line argument, only that test will be run.
   - If one or more tests have an [`only` annotation](#annotation), only those tests will be run.
   - If one or more tests have a [`skip` annotation](#annotation), every test except those will be run.
   - If none of the above is true, all tests will be run.
1. The runner evaluates every test.
   1. If the test has an [`sdl error` instruction](#instruction), the runner does the following:
      1. Reads and parses the config, taking note of the validation errors.
      1. **If no validation errors occurred, the runner throws an error.** (`sdl error` is a requirement, not a try-catch.)
      1. Compares the encountered errors to the `errors` snapshot.
      1. If the snapshot doesn't match the encountered errors, the runner generates a new snapshot and throws an error.
      1. Ends the test run, and starts evaluating the next test. (All other actions would require a parseable `server` schema.)
      1. The runner parses every `server` block.
   1. Parses the block and checks for errors.
   1. If the test has a [`check identity` instruction](#instruction), the runner converts the parsed block to SDL again, and checks if the two strings are the same. If they're not, the runner throws an error.
   1. The runner performs a `merge` check:
      1. Attemps to merge all [`server` blocks](#server), resulting in a merged config. (If there is only one [`server` block](#server), the runner will merge it with the default config.)
      1. Compares the merged config to the `merged` snapshot.
      1. If the snapshot doesn't match the merged config, the runner generates a new snapshot and throws an error.
   1. If there is exactly one [`server` block](#server), the runner performs a `client` check:
      1. Generates the client schema of the `server` block.
      1. Compares it to the `client` snapshot.
      1. If the snapshot doesn't match the generated schema, the runner generates a new snapshot and throws an error.
   1. If the test has an [`assert` block](#assert), the runner performs `assert` checks:
      1. If there is a [`mock` block](#mock), the runner sets up the mock HTTP client based on it.
      1. If there is at least one [`file` block](#file), the runner sets up the mock filesystem based on them.
      1. If there is an [`env` block](#env), the runner uses it for the app context.
      1. Creates an app context based on the [`server` block](#server).
      1. For each assertion in the block (0-based index `i`), the runner does the following:
         1. Runs the HTTP request on the app context.
         1. Compares the HTTP response to the `assert_{i}` snapshot.
         1. If the snapshot doesn't match the response, the runner generates a new snapshot and throws an error.

## Snapshots

`execution_spec` uses the [Insta](https://insta.rs) snapshot engine. Snapshots are automatically generated with a `.new` suffix if there is no pre-existing snapshot, or if the compared data didn't match the existing snapshot.

Instead of writing result cases in tests and updating them when behaviour changes, a snapshot-based testing workflow relies on auto-generation. Whenever a `.new` snapshot is generated, it means one of the following:

- Your code made an unexpected breaking change, and you need to fix it.
- Your code made an expected breaking change, and you need to accept the new snapshot.

It is your job to determine which one is the case, and take action accordingly.

I recommend using `cargo-insta`, especially this command:

```bash
cargo insta test --review
```

This will regenerate all snapshots without interrupting the test every time there's a diff, and it will also open the snapshot review interface, so you can accept or reject `.new` snapshots.

### `http_spec`

1. The name, and optionally the description, are read out and put into a [header](#header).
1. The GraphQL config is read out and put into a [`server` block](#server).
1. The client schema snapshot is auto-generated for the [`server` block](#server).
1. The merged SDL snapshot is auto-generated for the [`server` block](#server).
1. The `assert` property's `response` are removed from the YAML and converted into snapshots.
1. The `assert` property is converted to an [`assert` block](#assert).
1. The `mock` property is put into a [`mock` block](#mock).
1. If the `http_spec` had a `runner: fail` annotation (which is unsupported by `execution_spec`), the snapshot of the error is automatically generated.

### `graphql_spec`

#### client (1 server-sdl, 1 client-sdl)

1. The name is generated from the file name, and put into a [header](#header).
1. The server SDL is put into a [`server` block](#server).
1. The client SDL is put into the corresponding `client` snapshot.
1. The merged SDL snapshot is auto-generated for the [`server` block](#server).

These tests will not have a main action, since `client` checks are performed on all (non-`sdl error`) tests with only one [`server` block](#server).

#### merge (1+ server-sdl, 1 merged-sdl)

1. The name is generated from the file name, and put into a [header](#header).
1. The server SDLs are put into [`server` blocks](#server).
1. The merged SDL is put into the a `merged` snapshot.
1. If the test only has one server block, the client schema snapshot is auto-generated for the [`server` block](#server).

#### errors (1 server-sdl, 1 client-sdl with `@error` operator)

Each test's `.md` file may have a file name suffix of `-error` if the bare file name is already taken by a previously converted test.

1. The name is generated from the file name, and put into a [header](#header).
1. An [`sdl error` instruction](#instruction) is appended.
1. The server SDL is put into a [`server` block](#server).
1. The expected errors are put into an `errors` snapshot.

## Maintenance

1. To clean unused snapshots, run `cargo insta test --delete-unreferenced-snapshots`.
